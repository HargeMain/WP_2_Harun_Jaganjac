<div class="mood-tracker-container" [style.background-color]="primaryColor" [style.color]="secondaryColor">
    <div class="header-section">
        <span class="material-icons tracker-icon" [style.color]="secondaryColor">sentiment_satisfied_alt</span>
        <h2 class="title">Mood & Emotion Tracker</h2>
    </div>

    <div class="mood-main-layout">
        <div class="left-column">
            <form [formGroup]="moodForm" (ngSubmit)="saveMood()" class="mood-form">
                <div class="form-section">
                    <h3><span class="material-icons">schedule</span> When</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Date</label>
                            <input type="date" formControlName="date" [style.color]="secondaryColor">
                        </div>
                        <div class="input-group">
                            <label>Time</label>
                            <input type="time" formControlName="time" [style.color]="secondaryColor">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><span class="material-icons">emoji_emotions</span> How are you feeling?</h3>
                    <div class="mood-selector">
                        <div *ngFor="let mood of moodOptions" 
                                 class="mood-option"
                                 [class.selected]="moodForm.get('mood')?.value === mood.value"
                                 (click)="moodForm.get('mood')?.setValue(mood.value)"
                                 [style.border-color]="mood.color"
                                 [style.color]="mood.color">
                            <span class="mood-emoji">{{ mood.emoji }}</span>
                            <span class="mood-label">{{ mood.label }}</span>
                        </div>
                    </div>
                    <input type="range" formControlName="mood" min="1" max="10" step="1" class="mood-slider" hidden>
                </div>

                <div class="form-section">
                    <div class="input-row">
                        <div class="input-group">
                            <label>Primary Emotion</label>
                            <select formControlName="emotion" [style.color]="primaryColor">
                                <option value="">Select an emotion</option>
                                <option *ngFor="let emotion of emotionOptions" [value]="emotion">
                                    {{ emotion }}
                                </option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Intensity</label>
                            <div class="intensity-selector">
                                <span *ngFor="let i of [1,2,3,4,5]" 
                                            class="intensity-option"
                                            [class.selected]="moodForm.get('intensity')?.value === i"
                                            (click)="moodForm.get('intensity')?.setValue(i)">
                                    {{ i }}
                                </span>
                            </div>
                            <div class="intensity-label">
                                {{ getIntensityLabel(moodForm.get('intensity')?.value) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><span class="material-icons">psychology</span> What's influencing your mood?</h3>
                    <div class="multi-select-list">
                        <div *ngFor="let factor of factorOptions" 
                                 class="multi-select-option"
                                 [class.selected]="factors.value.includes(factor)"
                                 (click)="toggleFactor(factor)">
                            {{ factor }}
                            <span *ngIf="factors.value.includes(factor)" class="material-icons" style="font-size: 14px;">check</span>
                        </div>
                    </div>
                    <div class="array-container">
                        <div *ngFor="let factor of factors.value; let i = index" class="array-item">
                            {{ factor }}
                            <button type="button" (click)="removeFactor(i)" class="array-remove">
                                <span class="material-icons" style="font-size: 14px;">close</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="input-row">
                        <div class="input-group">
                            <label>Energy Level</label>
                            <input type="range" formControlName="energyLevel" min="1" max="10" step="1" class="energy-slider">
                            <div class="energy-label">{{ getEnergyLabel(moodForm.get('energyLevel')?.value) }} ({{ moodForm.get('energyLevel')?.value }}/10)</div>
                        </div>
                        <div class="input-group">
                            <label>Sleep Hours</label>
                            <input type="number" formControlName="sleepHours" step="0.5" min="0" max="24" [style.color]="secondaryColor">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><span class="material-icons">notes</span> Additional Notes</h3>
                    <div class="input-group">
                        <label>Notes</label>
                        <textarea formControlName="notes" placeholder="Any additional thoughts or context..." [style.color]="secondaryColor"></textarea>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Weather</label>
                            <input type="text" formControlName="weather" placeholder="Sunny, Rainy, etc." [style.color]="secondaryColor">
                        </div>
                        <div class="input-group">
                            <label>Location</label>
                            <input type="text" formControlName="location" placeholder="Home, Office, etc." [style.color]="secondaryColor">
                        </div>
                    </div>
                </div>

                <button type="submit" class="save-btn" [disabled]="moodForm.invalid || isLoading" 
                                [style.background-color]="secondaryColor" [style.color]="primaryColor">
                    <span *ngIf="isLoading" class="spinner"></span>
                    {{ isLoading ? 'Saving...' : 'Save Mood Entry' }}
                </button>
            </form>

            <div class="stats-container">
                <div class="current-mood-display" *ngIf="currentMood > 0">
                    <h3>Current Mood</h3>
                    <div class="current-mood-emoji">{{ getMoodEmoji(currentMood) }}</div>
                    <div class="current-mood-label">{{ getMoodLabel(currentMood) }}</div>
                    <div class="current-mood-value">{{ currentMood.toFixed(1) }}/10</div>
                </div>

                <div class="insights-section" *ngIf="aiInsights.length"></div>
                    <h3><span class="material-icons">auto_awesome</span> Emotional Insights</h3>
                    <div *ngFor="let insight of aiInsights" class="insight-card" [class]="insight.type">
                        <span class="material-icons insight-icon">psychology</span>
                        <div>
                            <p>{{ insight.message }}</p>
                            <span class="insight-category">{{ insight.category }}</span>
                        </div>
                    </div>
                </div>

                <div class="mood-metrics" *ngIf="moodEntries.length">
                    <h3><span class="material-icons">analytics</span> Mood Statistics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <span class="metric-value">{{ averageMood.toFixed(1) }}</span>
                            <span class="metric-label">Average Mood</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">{{ streakDays }}</span>
                            <span class="metric-label">Day Streak</span>
                        </div>
                        <div class="metric-card"></div>
                            <span class="metric-value">{{ emotionalBalance.toFixed(0) }}%</span>
                            <span class="metric-label">Positive Balance</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">{{ moodConsistency.toFixed(0) }}%</span>
                            <span class="metric-label">Consistency</span>
                        </div>
                    </div>
                </div>

                <div class="mood-patterns" *ngIf="moodPatterns.length">
                    <h3><span class="material-icons">calendar_today</span> Weekly Patterns</h3>
                    <div class="patterns-grid">
                        <div *ngFor="let pattern of moodPatterns" class="pattern-day">
                            <div class="pattern-day-label">{{ pattern.dayOfWeek }}</div>
                            <div class="pattern-day-value">{{ pattern.count }}</div>
                            <div class="pattern-mood">{{ pattern.averageMood.toFixed(1) }}</div>
                        </div>
                    </div>
                </div>

                <div class="emotion-distribution" *ngIf="emotionDistribution.length">
                    <h3><span class="material-icons">pie_chart</span> Top Emotions</h3>
                    <div class="emotion-list">
                        <div *ngFor="let emotion of emotionDistribution" class="emotion-item">
                            <span class="emotion-label">{{ emotion.emotion }}</span>
                            <div class="emotion-bar">
                                <div class="emotion-fill" [style.width]="emotion.percentage + '%'"></div>
                            </div>
                            <span class="emotion-percentage">{{ emotion.percentage.toFixed(0) }}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <button (click)="resetMoodTracker()" class="reset-btn" [style.background-color]="secondaryColor" [style.color]="primaryColor">
                Reset Mood Tracker
            </button>
        </div>

        <div class="right-column">
            <div class="filter-bar">
                <div class="filter-group">
                    <label>Time Range:</label>
                    <select [(ngModel)]="filterDateRange" (change)="filterEntries()" class="filter-select" [style.color]="primaryColor">
                        <option value="all">All Time</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                        <option value="quarter">Last 3 Months</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Mood Level:</label>
                    <select [(ngModel)]="filterMoodRange" (change)="filterEntries()" class="filter-select" [style.color]="primaryColor">
                        <option value="all">All Moods</option>
                        <option value="low">Low (1-3)</option>
                        <option value="medium">Medium (4-6)</option>
                        <option value="high">High (7-10)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Emotion:</label>
                    <select [(ngModel)]="filterEmotion" (change)="filterEntries()" class="filter-select" [style.color]="primaryColor">
                        <option value="all">All Emotions</option>
                        <option *ngFor="let emotion of emotionOptions" [value]="emotion">
                            {{ emotion }}
                        </option>
                    </select>
                </div>
            </div>

            <div class="entries-header">
                <h3>Mood History</h3>
                <span class="entries-count" *ngIf="moodEntries.length">
                    {{ moodEntries.length }} entries
                </span>
            </div>
            
            <div class="entries-container" *ngIf="moodEntries.length">
                <table class="mood-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Mood</th>
                            <th>Emotion</th>
                            <th>Intensity</th>
                            <th>Energy</th>
                            <th>Sleep</th>
                            <th>Factors</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let entry of getDisplayedEntries()">
                            <td>
                                <div>{{ entry.date }}</div>
                                <div style="font-size: 12px; opacity: 0.7;">{{ entry.time }}</div>
                            </td>
                            <td>
                                <div class="mood-column">
                                    <span class="mood-emoji-small">{{ entry.moodEmoji }}</span>
                                    <div class="mood-info">
                                        <span class="mood-level">{{ entry.mood }}/10</span>
                                        <span class="mood-description">{{ getMoodLabel(entry.mood) }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="emotion-tag">{{ entry.emotion }}</span>
                            </td>
                            <td>
                                <span class="intensity-display">{{ getIntensityLabel(entry.intensity) }}</span>
                            </td>
                            <td>
                                {{ entry.energyLevel }}/10
                                <div style="font-size: 11px; opacity: 0.7;">{{ getEnergyLabel(entry.energyLevel) }}</div>
                            </td>
                            <td>{{ entry.sleepHours }}h</td>
                            <td>
                                <div class="factors-display">
                                    <span *ngFor="let factor of entry.factors.slice(0, 3)" class="factor-tag">
                                        {{ factor }}
                                    </span>
                                    <span *ngIf="entry.factors.length > 3" class="factor-tag">
                                        +{{ entry.factors.length - 3 }}
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="pagination" *ngIf="totalPages > 1">
                    <button class="pagination-button" (click)="previousPage()" [disabled]="currentPage === 1">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    
                    <button *ngFor="let page of getPageNumbers()" 
                                    class="pagination-button" 
                                    [class.active]="page === currentPage"
                                    (click)="goToPage(page)">
                        {{ page }}
                    </button>
                    
                    <button class="pagination-button" (click)="nextPage()" [disabled]="currentPage === totalPages">
                        <span class="material-icons">chevron_right</span>
                    </button>
                    
                    <span class="pagination-info">
                        Page {{ currentPage }} of {{ totalPages }}
                    </span>
                </div>
            </div>
            
            <div *ngIf="!moodEntries.length && !isLoading" class="empty-state">
                <p>No mood entries yet. Start by logging your current mood above!</p>
            </div>
        </div>
    </div>

    <div class="save-notification" *ngIf="showSaveNotification">
        <span class="material-icons">check_circle</span>
        Mood saved successfully!
    </div>
</div>
